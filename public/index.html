<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Realtime Voting Dashboard</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 0;
  }

  header {
    padding: 20px;
    background: rgba(0,0,0,0.2);
  }

  h1 {
    margin: 0;
    font-size: 2rem;
    letter-spacing: 1px;
  }

  main {
    padding: 20px;
    max-width: 900px;
    margin: auto;
  }

  input, button {
    padding: 10px 15px;
    margin: 5px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
  }

  button {
    cursor: pointer;
    background: #ffce00;
    color: #000;
    font-weight: bold;
    transition: 0.3s;
  }

  button:hover {
    background: #fff;
  }

  #pollsDiv {
    margin-top: 30px;
  }

  .poll {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 15px;
    margin: 20px auto;
    text-align: left;
  }

  .poll button {
    margin: 5px 5px 5px 0;
    background-color: #00ff99;
    font-weight: bold;
  }

  .poll button:hover {
    background-color: #00cc66;
    color: #fff;
  }

  canvas {
    margin-top: 10px;
  }

  #leaderboard {
    margin-top: 40px;
  }

  .leaderboard-item {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    margin: 5px auto;
    border-radius: 8px;
    max-width: 500px;
    display: flex;
    justify-content: space-between;
  }

</style>
</head>
<body>

<header>
  <h1>ðŸŒŸ Realtime Voting Dashboard ðŸŒŸ</h1>
</header>

<main>

<div id="login">
  <input id="username" placeholder="Username">
  <input id="password" placeholder="Password" type="password">
  <button onclick="register()">Register</button>
  <button onclick="login()">Login</button>
</div>

<div id="pollsDiv" style="display:none;">
  <h2>Create a Poll</h2>
  <input id="question" placeholder="Poll question">
  <input id="options" placeholder="Comma separated options">
  <button onclick="createPoll()">Create Poll</button>

  <h2>Available Polls</h2>
  <div id="polls"></div>

  <h2>Leaderboard</h2>
  <div id="leaderboard"></div>
</div>

</main>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let token = '';
const socket = io();
const charts = {};

// Update polls, charts, and leaderboard
socket.on('pollsUpdate', data => {
  const container = document.getElementById('polls');
  container.innerHTML = '';

  // Sort polls by total votes for leaderboard
  const leaderboardData = [...data].sort((a,b) => {
    const aVotes = a.options.reduce((sum,o)=>sum+o.votes,0);
    const bVotes = b.options.reduce((sum,o)=>sum+o.votes,0);
    return bVotes - aVotes;
  });

  // Render polls
  data.forEach(p => {
    const div = document.createElement('div');
    div.classList.add('poll');
    div.innerHTML = `<h3>${p.question}</h3>` +
      p.options.map((o,i) =>
        `<button onclick="vote(${p.id},${i})">${o.text} (${o.votes})</button>`
      ).join(' ') +
      `<canvas id="chart-${p.id}" height="100"></canvas>`;
    container.appendChild(div);

    // Chart rendering
    const ctx = document.getElementById(`chart-${p.id}`).getContext('2d');
    const labels = p.options.map(o=>o.text);
    const votes = p.options.map(o=>o.votes);

    if (charts[p.id]) {
      charts[p.id].data.datasets[0].data = votes;
      charts[p.id].update();
    } else {
      charts[p.id] = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets:[{label:'Votes',data:votes,backgroundColor:'#ffce00'}] },
        options: { responsive:true, animation:{duration:600}, scales:{y:{beginAtZero:true}} }
      });
    }
  });

  // Render leaderboard
  const lb = document.getElementById('leaderboard');
  lb.innerHTML = '';
  leaderboardData.forEach((p,i)=>{
    const totalVotes = p.options.reduce((sum,o)=>sum+o.votes,0);
    const div = document.createElement('div');
    div.classList.add('leaderboard-item');
    div.innerHTML = `<span>${i+1}. ${p.question}</span><span>${totalVotes} votes</span>`;
    lb.appendChild(div);
  });
});

// Register
function register() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  fetch('/api/register',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username:u,password:p})
  }).then(r=>r.json()).then(d=>alert(d.message||d.error));
}

// Login
function login() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  fetch('/api/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({username:u,password:p})
  }).then(r=>r.json()).then(d=>{
    if(d.token){
      token=d.token;
      document.getElementById('login').style.display='none';
      document.getElementById('pollsDiv').style.display='block';
    } else alert(d.error);
  });
}

// Create Poll
function createPoll() {
  const q = document.getElementById('question').value;
  const opts = document.getElementById('options').value.split(',');
  fetch('/api/polls',{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
    body:JSON.stringify({question:q,options:opts})
  });
}

// Vote
function vote(pollId, optionIndex) {
  socket.emit('vote',{pollId,optionIndex});
}

</script>
</body>
</html>
